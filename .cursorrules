# Project Constitution: Version 1.1 (Trans Model Directory)

## 0. Role & Persona
- **Senior Frontend Architect and Vibe Coding Specialist.**
- **Project:** Building "Version 1.0," a high-performance, mobile-first landing page for X (Twitter) to OnlyFans/Fansly conversion.
- **Vibe:** Efficient, minimalist, pragmatic, obsessed with "Zero Friction."
- **Goal:** Maximize CTR by eliminating login walls and loading delays.
- **Constraint:** "Zero Cost" stack (Free Tier focus).

### 0.1 Context Gateway Protocol (MANDATORY)
> **CRITICAL:** At the START of every session, you MUST read `PROJECT_STRUCTURE.md` before making any code changes.

- **Why:** `PROJECT_STRUCTURE.md` is the single source of truth for:
  - Current project architecture and directory structure
  - High-dependency file summaries and cross-references
  - Active development phases and context breadcrumbs
  - Archived log locations and historical context
- **How:** Use `view_file` on `PROJECT_STRUCTURE.md` as your first action when starting work.
- **Sync Rule:** After significant changes, update `PROJECT_STRUCTURE.md` to reflect new state.


## 1. Technical Stack (Immutable)
- **Framework:** Next.js 15 (App Router) - *Downgraded from 16 for stability.*
- **Language:** TypeScript (Strict mode).
- **Styling:** Tailwind CSS v4 + Shadcn/UI (Radix Primitives).
- **Database:** Supabase (PostgreSQL).
- **Storage:** Cloudflare R2 (S3 Compatible API).
     - **Format:** WebP (Pre-converted). 
     - **Structure:** `bucket/[model-slug]/filename.webp`.
- **Hosting:** Cloudflare Pages.
- **State Management:** URL Search Params (nuqs or native) for global state; React Hooks for local state.

## 2. Core Architectural Rules

### 2.1 The "No-Login" Philosophy
- NEVER create user authentication flows for visitors.
- NEVER gate content behind a login screen.
- **Favorites Feature:** Use `localStorage` and a custom `useFavorites` hook.
- **Requirement:** Handle hydration mismatches; return data only after client mounting.

### 2.2 Mobile-First UI/UX
- **Design Priority:** Designed for 375px width first.
- **Interactions:** Use `active:` states for touch feedback;
44px minimum touch targets.
- **Category Pills:** Horizontal scrolling (`overflow-x-auto`, `snap-x`) with hidden scrollbars.
- **Performance:** Strict use of Next.js `Image` component and Skeleton loaders.

### 2.3 Data Fetching & Supabase
- **Read Access:** Use the `anon` key for public feed fetching.
- **RLS:** SELECT allowed for `anon`; INSERT/UPDATE/DELETE blocked (reserved for `service_role`).
- **Pattern:** Server Components for initial fetch (SEO);
Client Components for filtering.

### 2.4 Cloudflare R2 (Media Handling)
- **Source:** Images and videos hosted on Cloudflare R2.
- **Multi-Bucket Strategy:**
  - `trans-image-directory` for profile images (via `NEXT_PUBLIC_R2_DOMAIN`)
  - `stories` bucket for story media (via `NEXT_PUBLIC_STORIES_DOMAIN`)
- **URL Logic:** Use `getImageUrl()` helper from `src/lib/utils.ts` for consistent URL construction.
- **Directory Strategy:** ALWAYS categorize images into folders named after the model's slug (e.g., `valentina-aguirre/`).
- **Hybrid Video Strategy:**
  - Upload BOTH `.webm` (primary) and `.mp4` (fallback) for all video content.
  - Derive WebM URL by replacing `.mp4` extension in `media_url`.
  - Always include `poster_url` for video thumbnails.
- **Optimization:** Use `sharp` scripts locally; do not rely on on-the-fly server optimization.
- **Caching:** All R2 uploads MUST include `Cache-Control: public, max-age=31536000, immutable` header (files are timestamped and never change).

### 2.5 Geolocation Handling
- Always use request.headers.get('x-user-city') in Server Components.
- In Middleware, use cf-ipcity. Default to 'Unknown' if missing.
- **Crawler Detection (Sentry Phase):**
    - Middleware MUST detect social media crawlers using the standard regex pattern.
    - If `cf-verified-bot` exists, WHITE LIST the crawler (set `isCrawler = false`).
    - Propagate `x-is-crawler: '1'` header only when a bot is detected.
- **Security Headers:**
    - Middleware MUST set `X-Frame-Options: SAMEORIGIN`, `X-Content-Type-Options: nosniff`, and `Referrer-Policy: strict-origin-when-cross-origin` on ALL responses.

### 2.6 Navigation
- Do not use <Link> for feed tab switching.
- Use useQueryState from nuqs to update the ?feed= parameter.

### 2.7 Images
- All verified checkmarks and UI icons must be SVGs from lucide-react.
- Do not import icon images.

### 2.8 Next.js 15 Specifics
- **Middleware Location:** MUST be placed in `src/middleware.ts` (not root).
- **Nuqs Integration:** ALWAYS ensure `<NuqsAdapter>` wraps children in `src/app/layout.tsx`.
- **Async Headers:** `headers()` and `cookies()` are async functions in Next.js 15. Await them before use.
- **Edge Runtime:** ALL API routes interacting with AWS SDK or R2 (`src/app/api/...`) MUST export `const runtime = 'edge'` to function on Cloudflare Pages.
- **Image Optimization:** Next.js Image component is configured with AVIF/WebP formats and 1-year cache TTL. Use `next/dynamic` for heavy components (modals, below-the-fold content) to reduce initial bundle size.

### 2.8 Server Actions & Mutations
- **Security:** ALL database writes must happen in `src/app/actions/` files marked with `"use server"`.
- **Client Usage:** UI components call Server Actions via `startTransition` or `useEffect` (for logging).
- **Error Handling:** Server Actions must return `{ success: boolean, error?: string }` objects, never throw raw errors to the client.

### 2.9 UI/UX Physics & Layout Standards
- **Scroll Snap:** For simple lists, use `snap-x`.
### 2.10 Analytics & Data Mapping
- **API Response:** Use CamelCase in specialized `ModelSummary` or `SourceSummary` objects returned by Aggregation APIs to maintain internal consistency, but allow snake_case from DB-level RPC calls if explicitly mapped in the frontend.
- **Frontend Mapping:** The `onDataLoaded` callback in `AnalyticsDashboard` must propagate all raw metrics to parent pages to ensure complete data availability for sidebars and other child components.
- **Dual Analytics System:** Dashboard API returns BOTH filtered analytics (based on current selections) AND all-models metrics (unfiltered for sidebar reference) in single request.
- **Sidebar Integration:** Parent components use `sidebarMetrics` (unfiltered) for comprehensive model comparison while main dashboard uses filtered data.
- **Robustness:** Mapping logic should handle both `snake_case` (raw API) and `camelCase` (mapped component state) property names to prevent "0 views" or "undefined" errors during API structural changes.
- **Responsive Architecture (The "Hybrid" Rule):**
  - **Mobile (< 1024px):** Single column, Full width, Carousel Gallery (Swipe).
- **Desktop (>= 1024px):** Dual Column "Split View".
    - **Left:** Sticky Info Panel + CTA (must stay in view).
- **Right:** Vertical Scroll Gallery (No Carousel).
    - **Constraint:** Max width is max-w-4xl for standard profiles, but allows max-w-7xl when 'Story Mode' layout is active.

### 2.10 Navigation & Interaction - **Gallery Controls:** Desktop users must see Glassmorphism Arrow Buttons (Left/Right).
Mobile users rely on Swipe. - **Dynamic Buttons:** "Money Buttons" must adapt text based on `is_verified` status (Trust psychology).

### 2.11 Localization Protocol (i18n)
- **Zero-Deps Approach:** Do NOT install `next-i18next` or complex libraries. Use the existing lightweight `src/lib/i18n.ts` dictionary.

### 2.12 Conversion & Analytics Protocol
- **External Links:** ALL buttons that lead to OnlyFans/Fansly MUST use a standard `<a>` tag with `target="_blank"` and `rel="noopener noreferrer"`.
Do not use `useRouter().push` for external links.

- **Telemetry:** Every conversion click MUST trigger `trackClick(modelId, type)` before the user leaves.
- **Dynamic Labeling:** Never hardcode "Chat with". Always use the `is_verified` logic to determine if the text should be "Chat with Me" or "Chat with [Name]".
- **Detection:** Always rely on `x-user-country` header (passed from Middleware) for language decisions.
- **Content Strategy:**
  - Static UI text MUST be added to `DICTIONARY` in `i18n.ts`.
- Database content (Models) should support optional `_es` columns for key text fields (Bio), falling back to English if null.
- **API Limits & Scaling:** Supabase PostgREST has a 1000 row default limit. 
- **Safari Compatibility Protocol:**
    - **CRITICAL:** ALL high-intent conversion buttons (CTAs) MUST use direct `<a>` tags for external redirects.
    - **ITP Mitigation:** Safari's Intelligent Tracking Prevention blocks `window.open` or `window.location.href` redirects within `onClick` handlers if they target external domains from "gateway" pages.
    - **No-JS Navigation:** Even with `sendBeacon`, Safari may block popups if there's any delay. Use pure HTML navigation where possible.

### 2.16 Gallery Items Architecture (Hybrid Video Support)
- **Database:** Use `gallery_items` table instead of deprecated `gallery_urls` array.
- **Mobile Gallery Fix:** 
    - The mobile horizontal scroll container (`flex w-full overflow-x-auto`) REQUIRES `flex-shrink-0 w-full` on child slides.
    - WITHOUT these classes, slides collapse to 0 width and cause a black screen.
    - ALWAYS use `snap-x snap-mandatory` for smooth mobile carousel feel.
        - ALWAYS fetch in `DESC` order to prioritize recent data.
        - **Recursive Pagination:** For dashboards, implement a `while` loop with `.range(from, to)` to fetch chunks until the full range (capped at 10,000) is retrieved.
        - **Stable Ordering:** ALL paginated queries must include a stable secondary sort column (e.g., `.order('created_at').order('id')`) to prevent missing/dup rows.
        - **Materialized Views:** For high-volume analytics (>10k events), ALWAYS query materialized views (`analytics_daily_stats` or `analytics_hourly_stats`) instead of raw event logs to ensure sub-second performance.
        - **Today/Last Hour Granularity:** Use `analytics_hourly_stats` for timeframes requiring hourly resolution.
        - **Dashboard Synchronization:** Derive ALL breakdowns (Sources, Countries, Models) from the exact same filtered dataset in a single-pass aggregation in the API. NEVER perform independent summary queries that could lead to data drift or mismatched totals.
        - **Bucket Consistency:** When querying time-bucketed data (Materialized Views), truncate filter start times to the bucket boundary (e.g., set minutes to 0 for hourly views) to prevent data loss.
        - **Real-Time Pulse:** Use `/api/admin/live-pulse` for raw session counts (60s window). This query MUST include `.lte(now())` to exclude future-dated mock data.
        - **Analytics Mapping:** When filtering by source name, the API must map human-readable names (e.g., "Instagram") to their underlying tracking link UUIDs using a `sourceMap`.
        - **Debug Bypass:** Telemetry ingestion respects `?th_debug=human` parameter if `ALLOW_DEBUG_TRACKING=true`. This bypasses BOT DETECTION and ensures events are recorded from developer browsers.
        - **Parameter Robustness:** API routes must support both singular and plural parameter names for filters (e.g., `country` and `countries`) to accommodate different frontend calling patterns.
        - Use `page_view` and `link_click` as consistent event types.
        - **Materialized View Refresh:** 
            - Always use `scripts/refresh-analytics-views.ts` to manually refresh analytics after bulk data modifications.
            - The script verifies data integrity by comparing raw count vs. view total (`total_events` column sum).
            - Verification MUST handle Supabase's 1000-row limit using recursive pagination.
- **Tracking Link Management:**
    - Per-model tracking links are managed via the `TrackingLinkManager` component.
    - **Database Schema:**
        - `tracking_links` table uses `click_count` (int) for denormalized counts.
        - `tracking_sources` table handles traffic sources and MUST have a URL-friendly `slug`.
        - `is_archived` boolean is used for soft-deleting tracking links.
    - **API Routes:**
        - `/api/admin/tracking-links`: Fetch/Create links for a model.
        - `/api/admin/tracking-sources`: Manage traffic sources (global and custom).
    - **Hydration:** Admin components must handle hydration carefully using `mounted` state checks.

### 2.13 Stories Logic
- Story Viewer must use `nuqs` for state management (`?story=ID&si=INDEX`) to ensure shareability and resume playback.
- **Navigation Rule:** Internal navigation (switching between models/stories) MUST use `history: 'replace'` to prevent polluting the browser history stack.
- **Timestamp Logic:** NEVER manually update `last_story_added_at`. Rely strictly on the Postgres Trigger (`on_story_created`) to handle this automatically.
- **Filtering:** Main Feed stories must ONLY show models with active, unpinned groups.
- **Visuals:** Recent stories must use `bg-gradient` rings; Pinned stories use `bg-gray`.
- **Deep Linking:** The Story Viewer MUST maintain the `?story=UUID&si=INDEX` parameters in the URL bar at all times to allow instant copying/sharing and resume playback.
- **Action Bar:** Must contain two distinct actions:
    1. **Share (Icon):** Triggers Native Share Sheet (Viral Loop).
    2. **Respond (Text):** Triggers Copy & Go -> OnlyFans (Conversion Loop).
- **Animation System:** Use `animationType` state (`'story'` | `'model'`) to differentiate transitions:
    - **Story transitions:** `animate-in fade-in zoom-in-95 duration-300`
    - **Model transitions:** `animate-in slide-in-from-right-full duration-500 ease-out`
- **Navigation Isolation:** Pinned and Feed story groups MUST have separate neighbor calculations. Swiping on a pinned story navigates only to other pinned stories.
- **Chain Snapshot Mechanism:** When opening a story viewer, the chain (unseen or seen) is snapshotted at open time. Navigation uses this snapshot to maintain chain isolation, preventing groups from jumping between chains mid-navigation even if their viewed status changes. The snapshot is stored in `activeChainGroupIds` state and used for all neighbor calculations during navigation.
- **Progress Bar Visibility:**
  - **Main Layout** (`!disableLongPress`): Progress bars ALWAYS visible, even for single-story blocks
  - **Model Profile** (`disableLongPress`): Progress bars hidden for single-story blocks, visible only when `stories.length > 1`
  - **Condition:** `{(!disableLongPress || stories.length > 1) && (...)}`
- **Blur Effect Architecture (React Portal):**
  - StoryViewer MUST render via `createPortal` to `#story-portal` (defined in `layout.tsx`)
  - Layout structure: `#main-content` (gets blurred) + `#story-portal` (StoryViewer, outside blur scope)
  - CSS targets `body.story-open #main-content` for targeted blur effect
  - StoryViewer adds `story-open` class to body on mount, removes on unmount
  - Result: Instagram-style frosted glass with blurred background, clear story overlay
- **Story-Level View Tracking (Instagram Style):**
  - Individual story IDs are tracked in localStorage, not group IDs
  - Hook: `useViewedStories` provides `markStoryAsViewed`, `isStoryViewed`, `hasUnseenStories`, `getFirstUnseenStoryIndex`, `isGroupFullyViewed`
  - **Ring Color Logic:** Recent groups show gradient ring if `hasUnseenStories(group.stories)` returns true; pinned groups always show gray
  - **Resume Playback:** `getFirstUnseenStoryIndex(stories)` returns the index of the oldest unseen story for resume
  - **Group Seen Status:** A group is marked as "seen" (gray ring) only when ALL stories inside have been viewed
  - **New Story Alert:** If a model uploads a new story to a previously-seen group, the group automatically shows as unseen (gradient ring)

### 2.15 Category Pills & Filtering
- **Frequency Algorithm:** Display top 15 most-used tags (calculated server-side).
- **State Management:** Use `FilterableFeed` client wrapper to bridge Server Component data with client-side filtering.
- **Visibility:** Hide CategoryPills on "Favorites" feed.
- **Styling:**
  - **Container:** iOS 26-style glass border container with extremely subtle backdrop blur (`backdrop-blur-[2px]`), minimal background (`rgba(255, 255, 255, 0.005)`), and visible border (`rgba(255, 255, 255, 0.12)`)
  - **Active Pills:** `bg-[#00FF85] text-black border border-[#00FF85]` with Electric Emerald glow
  - **Inactive Pills:** `bg-white/10 backdrop-blur-xl border-0` (no border) with subtle text shadow for readability
  - **Floating Design:** Individual floating glassmorphism pills, no background bar behind them
  - **Horizontal Extension:** Container extends slightly beyond content area (`-mx-2 px-2`) to make borders visible

### 2.14 Conversion Protocol (User Interaction)
- **"Respond" Button Rule:** ALL buttons labeled "Respond" or "Respond to Story" MUST use the "Copy & Go" pattern.
- **Copy & Go Pattern:**
    1. Optimistically copy the context URL (deep link) to clipboard.
    2. Immediately open the external destination (OnlyFans/Fansly) in a new tab.
    3. Display a micro-toast confirming "Link Copied!" to the user.
- **Implementation:** Use the `useShare` hook's `copyAndGo(deepLink, externalUrl)` function.
- **Rationale:** Users land in the model's DMs with the story link ready to paste, providing context for the conversation.
- **Share Button Rule:** ALL share icons must attempt `navigator.share` first (native mobile), then fall back to `navigator.clipboard.writeText` with visual feedback.

### 2.16 Gallery Items Architecture (Hybrid Video Support)
- **Database:** Use `gallery_items` table instead of deprecated `gallery_urls` array.
- **Schema:** `id`, `model_id`, `media_url`, `media_type`, `poster_url`, `width`, `height`, `sort_order`, `created_at`.
- **Type Definition:** `GalleryItem` interface in `src/types/index.ts`.
- **Video Playback Rules:**
  - Use `<video>` tag with dual `<source>` elements (WebM first, MP4 fallback).
  - Auto-play when visible (Intersection Observer with 50% threshold).
  - Pause and reset when not visible (resource optimization).
  - Loop infinitely, muted, no controls, `playsInline`.
  - Always include `poster` attribute for video thumbnail.
- **Fallback Logic:** If `gallery_items` is empty, fall back to `image_url` (legacy `gallery_urls` column has been removed in migration 012).
- **Locked VIP Teaser:**
  - The LAST gallery item (index === validItems.length - 1) must be rendered as a "Locked VIP Teaser".
  - NO separate end-card; the last item IS the conversion card.
  - Visual: Blurred media background (images: blur-[11px] base, blur-[19px] hover; videos: blur-[19px] base, blur-[13px] hover).
  - Overlay: Gradient from-black/80 via-black/50 to-black/30 with Lock icon, headline, and CTA button.
  - Click action: Redirects to `redirectUrl` or `socialLink` prop with analytics tracking.
  - Must work for both `media_type === 'image'` and `media_type === 'video'`.

### 2.17 Dark Mode Luxury Branding (Midnight Spectrum)
- **Color Palette (Immutable):**
  - Background: `#050A14` (Obsidian Navy) - `--background`
  - Primary: `#00FF85` (Electric Emerald) - `--primary`
  - Accent/Gold: `#D4AF37` (Rich Gold) - Used for verified badges, premium accents
  - Secondary: `#7A27FF` (Cyber Violet) - Gradient overlays, interactive states
  - Card/Surface: `#0A1221` (Deep Charcoal Navy) - `--card`
  - Muted/Foreground: `#94A3B8` - `--muted-foreground`
- **Typography System:**
  - Headlines (h1-h4): `var(--font-serif)` (Playfair Display) with `font-weight: 500` and `letter-spacing: -0.025em`
  - Body: `var(--font-sans)` (Montserrat)
  - Global styles defined in `globals.css` `@layer base`
- **Custom Utility Classes (globals.css):**
  - `.glass-panel`: `backdrop-blur-xl bg-white/5 border border-white/10`
  - `.gold-glow`: Subtle shadow using Rich Gold (`oklch(78% 0.13 85 / 0.3)`)
  - `.emerald-button`: `bg-primary text-primary-foreground` with Electric Emerald glow
  - `.emerald-glow`: Neon glow effect for primary actions
- **Component Styling Rules:**
  - All CTAs use Electric Emerald (`#00FF85`) with black text for high contrast
  - Verified badges use Rich Gold (`#D4AF37`) with drop shadow
  - Glassmorphism effects use `backdrop-blur-xl` with subtle white/black overlays
  - NO pink/rose/blue accents from previous iteration (replaced with Midnight Spectrum)

### 2.18 Visual Memory System (Viewed Profiles)
- **Hook:** `useViewedModels` in `src/hooks/use-viewed-models.ts`
  - Storage key: `'transpot-viewed-models'`
  - Hydration-safe: Loads from localStorage only after client mount
  - Functions: `markAsViewed(id)`, `isViewed(id)`, `viewedIds` array
- **ModelCard Visual States:**
  - **Unviewed:** `grayscale-[0.80]` (80% grayscale) + vignette overlay (86% opacity dark edges)
  - **Viewed:** `grayscale-0` (full color) + no vignette
  - **Hover on Unviewed:** Smooth 500ms transition to `grayscale-0`
  - **Vignette:** Radial gradient `transparent 35% → rgba(0,0,0,0.86) 100%` for "unseen" signal
- **Implementation:**
  - ModelCard calls `markAsViewed(slug)` on click (profile visit)
  - Conditional classes based on `isViewed(slug)` state
  - Vignette overlay fades out on hover/viewed with `transition-opacity duration-500`

### 2.20 Admin Design System - Solar Spectrum (Light Mode)
- **Theme Switcher:** Use `.admin-light-mode` class on `document.body` for theme activation.
- **Color Philosophy:** Use OKLCH color space for perceptually uniform gradients and high-contrast text.
- **Glassmorphism (iOS 26 Liquid Glass):**
    - **Backdrop:** `backdrop-blur(24px) saturate(140%)`.
    - **Reflective Borders:** 
        - Top/Left: Translucent white (`oklch(100% 0 0 / 0.6)`) to catch highlights.
        - Bottom/Right: Subtle shadow (`oklch(85% 0.01 250 / 0.2)`) to simulate thickness.
    - **3D Depth:** Multi-layered `box-shadow` combining soft ambient occlusion with direct drop shadows.
- **Layout Standards:**
    - Cards MUST use `liquid-glass-elevated` or equivalent overrides in light mode.
    - Text MUST prioritize accessibility with dark primary/secondary contrast ratios.
- **Persistence:** Always use `useAdminTheme` hook in the main layout to ensure theme state is synchronized with `localStorage`.
- **Date Handling:**
    - ALWAYS use local date parsing (`new Date(year, month - 1, day)`) for UI display labels to prevent "one-day-off" UTC bugs.
    - Standardize all database/API communications to YYYY-MM-DD (ISO strings) in UTC where possible, but convert to local on the client.
- **Menu/Popover Positioning:**
    - For high-priority UI elements like DatePickers or Dropdowns that must appear above all content, ALWAYS use `createPortal` to render at the `document.body` level.
    - Implement "Smart Positioning" that checks viewport height and flips the menu above the trigger button if space is insufficient.

### 2.19 Story Visual Memory System
- **Hook:** `useViewedStories` in `src/hooks/use-viewed-stories.ts`
  - Storage key: `'transpot-viewed-story-ids'` (tracks individual story IDs, not group IDs)
  - Hydration-safe: Loads from localStorage only after client mount
  - Functions: `markStoryAsViewed(storyId)`, `isStoryViewed(storyId)`, `hasUnseenStories(stories[])`, `getFirstUnseenStoryIndex(stories[])`, `isGroupFullyViewed(stories[])`, `viewedStoryIds` array
  - **Real-Time Sync:** Custom events (`viewedStoryIdsUpdated`) + storage events for cross-component/cross-tab sync
- **StoryCircle Visual States:**
  - **Unviewed (Recent Groups):** Electric Emerald → Gold → Violet gradient ring (`bg-gradient-to-tr from-[#00FF85] via-[#D4AF37] to-[#7A27FF]`) when `hasUnseenStories(group.stories)` is true
  - **Viewed (Recent Groups):** Gray ring (`bg-muted-foreground/40`) when all stories are viewed
  - **Pinned Groups:** Always gray ring (pinned stories don't have seen/unseen dynamic)
  - **Transition:** 300ms for smooth visual feedback
- **Story Sorting (Instagram-Style):**
  - **Primary:** Groups with unseen stories appear first (left side of `HomeStoriesBar`)
  - **Secondary:** Within each category (unseen/seen), newest stories first
  - **Auto-Update:** Groups automatically move to end when all stories are viewed (no page reload needed)
- **Resume Playback:**
  - Stories resume from oldest unseen story using `getFirstUnseenStoryIndex(stories)`
  - If all stories seen, playback starts from index 0
  - Works consistently across main layout and model profile
- **Implementation:**
  - StoryViewer marks individual stories as viewed when displayed via `markStoryAsViewed(storyId)`
  - StoryCircle uses `hasUnseenStories(group.stories)` to determine ring color
  - HomeStoriesBar uses `hasUnseenStories` for sorting logic
  - Real-time sync ensures all components update instantly

### 2.21 Organization & Admin Dashboard Architecture (Nebula Integration)
- **Shared Primitives:** All dashboards MUST use the same "Nebula" layout components for structural consistency.
- **Layout Structure:** Always use `DashboardContainer` with `header`, `sidebar`, and `filters` slots.
- **Unified Sticky Block:** The `header` and `filters` must be unified within the `DashboardContainer` sticky area to prevent overlap.
- **Header Prop Pattern:** Prefer passing header branding and theme toggles via the `header` prop of `DashboardContainer` (or `AnalyticsDashboard` wrapper) rather than rendering manual headers inside the content area.
  ```tsx
  <DashboardContainer
    header={<DashboardHeader title="Organization Manager" />}
    sidebar={<SidebarModelList models={orgModels} ... />}
    filters={<DashboardFiltersBar filters={filters} ... />}
  >
    {/* Clean dashboard content here */}
  </DashboardContainer>
  ```
- **Security First:** Filter models by `organization_id` before passing to `SidebarModelList`.
- **Filter State:** Use Admin-compatible filter structure with arrays: `modelSlugs[]`, `countries[]`, `sources[]`.
- **API Parameters:** Send filters as JSON arrays for consistency.

### 2.20 Real-Time Synchronization (localStorage Hooks)
- **Pattern:** All localStorage-based hooks (`useFavorites`, `useViewedStories`, `useViewedModels`) support real-time sync
- **Mechanism:**
  - Custom events for same-window sync (`favoritesUpdated`, `viewedStoriesUpdated`)
  - Native `storage` events for cross-tab/window sync
  - All hook instances automatically update when any instance changes state
- **Benefits:**
  - Favorites appear in Favorites feed immediately without page reload
  - Story positions update automatically when viewed
  - Works across multiple browser tabs/windows
  - No manual refresh required for state consistency

## 3. Coding Standards & Style

### 3.1 Component Structure
- Functional Components with named exports.
- **Files:** `kebab-case.tsx`.
- **Components:** `PascalCase`.
- **Props:** Always define a TypeScript interface.

### 3.2 Shadcn/UI Workflow
- Use Shadcn primitives via CLI: `npx shadcn@latest add [component]`.
- Use `cn` utility (tailwind-merge) for customization.

### 3.3 The "Online Priority" Logic (The Shuffle)

  - Requirement: Models must be sorted by "Online" status first, then randomized.
- Logic:
    1. "Enrichment": Assign a random `isOnline` boolean (40% probability) to each model on page load.
2. "Sorting": Filter `isOnline: true` to the top of the feed.
3. "Shuffle": Randomize the order within the "Online" and "Offline" groups to create novelty.
- Implementation:
    - State must be lifted to `page.tsx` (the parent).
- Status is passed down as a prop (`isOnline`) to `ModelCard`.
- `page.tsx` must use `export const dynamic = 'force-dynamic'` to ensure a fresh shuffle on every refresh.

## 4. "Vibe Coding" Interaction Protocols

### 4.1 Planning Phase
- 3-bullet point plan for complex features.
- Identify required environment variables upfront.

### 4.2 Code Generation
- No placeholders (`// TODO`).
- Full functional code only.
- Self-correct imports and unused variables.

### 4.3 Human Verification Triggers
- **Security:** Explicitly confirm data exposure for Supabase queries.
- **Visual:** Describe the intended UI outcome (e.g., "Sticky header with background blur").

## 5. Directory Structure Map
- `/src/app`: Next.js App Router pages.
- `/src/components/ui`: Shadcn primitives.
- `/src/components/features`: Feature-specific components (e.g., `ModelCard`).
- `/src/lib/supabase`: Supabase client configuration.
- `/src/hooks`: Custom hooks (`useFavorites`, `useViewedModels`, `useViewedStories`, `useShare`, `useAnalytics`).
- `/src/app/admin`: Internal Dashboard (Authentication via `?key=` param).

## 6. Auto-Archive Protocol (Context Gateway)

### 6.1 Log File Management
- **Primary Log:** `Project_Log.md` in project root
- **Archive Location:** `/logs/archive/` directory
- **Source of Truth:** `PROJECT_STRUCTURE.md` (the "Map") always reflects current state

### 6.2 Archive Trigger Rules
- **Size Threshold:** When `Project_Log.md` exceeds **10KB**, archive oldest entries
- **Archive Naming:** `archive_YYYY-MM_phases.md` (e.g., `archive_2025-12_phases-1-5.md`)
- **Retention:** Archived files are read-only historical records

### 6.3 Archive Procedure
1. **Check Size:** Before adding new log entries, verify file size
2. **If > 10KB:**
   - Identify oldest phase blocks (Phase 1, Phase 2, etc.)
   - Move completed phases to `/logs/archive/archive_[date]_[phases].md`
   - Update `PROJECT_STRUCTURE.md` Context Breadcrumbs with archive reference
   - Keep only active/recent phases in `Project_Log.md`
3. **Map Update:** `PROJECT_STRUCTURE.md` must always list:
   - Current active log file location
   - Archive files with date ranges

### 6.4 Log Entry Format
- **Timestamp:** `[YYYY-MM-DD]` ISO format
- **Phase Marker:** `## Phase X.X: [Title]`
- **Status Badge:** `**Status:** Complete | In Progress | Blocked`
- **Sections:** Implementation, Decisions, Bug Fixes, Testing

### 6.5 Archive File Structure
```
/logs/archive/
├── archive_2025-12_phases-1-4.md    # Phase 1-4 (Scaffolding → Gallery)
├── archive_2026-01_phases-5.md      # Phase 5 (Dark Mode Rebranding)
└── README.md                        # Archive index with date ranges
```

### 6.6 Context Gateway Sync
- When archiving, update `PROJECT_STRUCTURE.md`:
  - Add entry to "Archived Logs" section
  - Update "Recent Development Focus" breadcrumbs
  - Ensure high-level summaries remain in active log


